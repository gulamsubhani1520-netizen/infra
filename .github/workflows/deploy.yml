- name: Deploy on EC2
  env:
    SA_PASSWORD: ${{ secrets.SA_PASSWORD }}
  run: |
    ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
    set -e
    cd ~/app

    echo "=== Current folder ==="
    pwd
    echo "=== Files in folder ==="
    ls -la

    # Ensure compose file exists
    if [ ! -f docker-compose.yml ] && [ ! -f docker-compose.yaml ]; then
      echo "ERROR: docker-compose.yml not found in ~/app"
      exit 1
    fi

    # Write env file for docker compose
    cat > .env << ENVEOF
    SA_PASSWORD=${SA_PASSWORD}
    ENVEOF

    echo "=== .env created ==="
    cat .env

    docker compose --env-file .env up -d --build
    docker compose ps
    curl -fsS http://localhost:8082/api/health
    EOF
